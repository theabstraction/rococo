(' #file.type rococo)

(' #include 
	"!scripts/types.sxy"
	"!scripts/mplat_sxh.sxy"
	"!scripts/mplat_types.sxy"
)

(namespace EntryPoint)
	(alias Main EntryPoint.Main)
	
(using Rococo)
(using Rococo.Graphics)
(using Rococo.Entities)
(using Sys.Type)
(using Sys.Maths)

(struct Material
	(Vec2 indexAndShine)
)

(struct Point
	(Vec2 position)
	(Vec2i uv)
	(Float64 alpha)
	(Material material)
	(Bool isMirrored)
	(Int64 masterIndex)
)

(struct GlobalState
	(Sys.IDog dog)
	(array Point points)
	(array Sys.ICat cats)
	(IString dogName)
	(IString squirrelName)
	(IString catName)
	(Float64 age)
	(Vec3 position)
	(Matrix4x4 world)
	(Bool isActive)
)

(method GlobalState.Construct : 
)

(function GlobalStateInit (GlobalState gs) -> :
	(array Point points 2)
	(gs.points = points)

	(array Sys.ICat cats 2)
	(gs.cats = cats)
	(gs.points.Push Point ((5 7)(0 1) 0.75((7 8)) true 17))
	(gs.points.Push Point ((8 9)(1 0) 0.25((6 5)) false 78))

	(Sys.ICat cat (Sys.NewCat))
	(gs.cats.Push cat)
	(gs.cats.Push cat)

	(IString dogName = NullString)
	(IStringBuilder squirrelName = (NewParagraphBuilder))
	(#build squirrelName "Geoff")

	(Sys.IDog dog (Sys.NewDog))
	(gs.dog = dog)
	(gs.dogName = dogName)
	(gs.squirrelName = squirrelName)

	(gs.catName = "Meow-Meow")

	(gs.age = 17.6)

	(gs.world =
		(1 0 0 0)
		(0 1 0 0)
		(0 0 1 0)
		(0 0 0 1)
	)

	(gs.position = 1.4 2.5 7.6)

	(gs.isActive = true)
)

(class Dog (defines Sys.IDog)
	(Float32 barkDecibels)
	(Int32 barkHz)
	(Int64 barkWatts)
	(Float64 bitePressureNewtons)
)

(method Dog.Construct :
	(this.Init)
)

(method Dog.Init -> :
	(this.barkDecibels = 120)
	(this.barkHz = 4000)
	(this.barkWatts = 20)
	(this.bitePressureNewtons = 9050)
)

(factory Sys.NewDog Sys.IDog :
	(construct Dog)
)

(class Cat (defines Sys.ICat)
	(Float32 mewDecibels)
	(Int32 mewkHz)
	(Int64 mewWatts)
	(Float64 bitePressureNewtons)
)

(method Cat.Construct :
	(this.Init)
)

(method Cat.Init -> :
	(this.mewDecibels = 115)
	(this.mewkHz = 8020)
	(this.mewWatts = 15)
	(this.bitePressureNewtons = 9050)
)

(factory Sys.NewCat Sys.ICat :
	(construct Cat)
)

(function Validate (Bool isOk) -> :
	(if (not isOk)
		(debug)
	)
)

(function TestInt32Transfer -> :
	(Sys.Reflection.SexyAssetFile assetFile = "!scripts/test/asset.sxya")

	(Vec2i v = 6 7)
	(reflect SaveAsset assetFile v)
	
	(Vec2i w)
	(reflect LoadAsset assetFile w)

	(Validate ((w.x == 6) and (w.y == 7)))
)

(function TestFloat32Transfer -> :
	(Sys.Reflection.SexyAssetFile assetFile = "!scripts/test/asset.sxya")

	(Vec2 v = 6 7)
	(reflect SaveAsset assetFile v)
	
	(Vec2 w)
	(reflect LoadAsset assetFile w)

	(Validate ((w.x == 6) and (w.y == 7)))
)

(struct Int32Array
	(array Int32 elements)
)

(function TestEmptyArrayTransfer -> :
	(Sys.Reflection.SexyAssetFile assetFile = "!scripts/test/asset.sxya")

	(Int32Array a)
	(reflect SaveAsset assetFile a)
	
	(Int32Array b)
	(reflect LoadAsset assetFile b)

	(Int32 length = b.elements.Length)
	(Validate (length == 0))

	(debug)
)

(function TestGlobalStateTransfer -> :
	(Sys.Reflection.SexyAssetFile assetFile = "!scripts/test/asset.sxya")
	
	(GlobalState globalState)

	(GlobalStateInit globalState)
	
	// save the global state to !scripts/test/asset.sxya
	(reflect SaveAsset assetFile globalState)

	// load the global state from !scripts/test/asset.sxya
	(GlobalState copiedState)
	(reflect LoadAsset assetFile copiedState)
	
	(Point p0)
	(p0 = (copiedState.points 0))
	
	(Point p1)
	(p1	= (copiedState.points 1))
	
	(Sys.ICat cat0)
	(cat0 = (copiedState.cats 0))
	
	(Sys.ICat cat1)
	(cat1 = (copiedState.cats 1))
	
	(debug)
)

(function Main (Int32 id)->(Int32 exitCode):
	(IInstances instances (Instances))
	(instances.SetMaterialMacro "!textures/hv/materials/hi-rez/" )
	(instances.LoadMaterialArray "#m/" 1024)
	
	(IHQFonts fonts (HQFonts))
	(fonts.Build (#HQFontEditorFont))
	(fonts.SetFaceName "Courier New")
	(fonts.MakeBold)
	(fonts.AddRange 32 127)
	(fonts.AddCharacters "£")
	(fonts.SetHeight 24)
	(fonts.Commit)

	(fonts.Build (#HQFontTitleFont))
	(fonts.SetFaceName "Tahoma")
	//(fonts.MakeBold)
	(fonts.AddRange 32 127)
	(fonts.SetHeight 80)
	(fonts.Commit)
	
	(fonts.Build (#HQFontDebuggerFont))
	(fonts.SetFaceName "Consolas")
	//(fonts.MakeBold)
	(fonts.AddRange 32 127)
	(fonts.AddCharacters "£")
	(fonts.SetHeight 28)
	(fonts.Commit)

	(fonts.Build (#HQFontInfoFont))
	(fonts.SetFaceName "Times New Roman")
	(fonts.AddRange 32 127)
	(fonts.AddCharacters "£")
	(fonts.SetHeight 28)
	(fonts.Commit)

	(TestInt32Transfer)
	(TestFloat32Transfer)
	(TestEmptyArrayTransfer)
	(TestGlobalStateTransfer)
)